<script type="text/javascript">
//JavaScript Document
$.fn.toggle = function( fn, fn2 ) {
    var args = arguments,guid = fn.guid || $.guid++,i=0,
    toggle = function( event ) {
      var lastToggle = ( $._data( this, "lastToggle" + fn.guid ) || 0 ) % i;
      $._data( this, "lastToggle" + fn.guid, lastToggle + 1 );
      event.preventDefault();
      return args[ lastToggle ].apply( this, arguments ) || false;
    };
    toggle.guid = guid;
    while ( i < args.length ) {
      args[ i++ ].guid = guid;
    }
    return this.click( toggle );
}

function h0(){
	var h1=$(window).height()-260
	$(".zz_bg").css('height',h1)
	var h2=$('#yg_in').offset().left
	$('.top_ul').css('left',h2)
	
	var wsp0_0=0;
	var wsp0_1=0;
	var wsp0_2=0;
	var wsp0_3=0;
	var wsp0=$('#content_div0 ul li').eq(0).children('span');
	var wsp1=$('#content_div1 ul li').eq(0).children('span');
	var wsp2=$('#content_div2 ul li').eq(0).children('span');
	var wsp3=$('#content_div3 ul li').eq(0).children('span');
	
	for( var i=0; i<wsp0.length;i++){
		wsp0_0+=wsp1.eq(i).width();
	}
	$('#content_div0 ul li').css('width',wsp0_0);
	for( var i=0; i<wsp1.length;i++){
		wsp0_1+=wsp1.eq(i).width();
	}
	$('#content_div1 ul li').css('width',wsp0_1);
	for( var i=0; i<wsp2.length;i++){
		wsp0_2+=wsp2.eq(i).width();
	}
	$('#content_div2 ul li').css('width',wsp0_2);
	for( var i=0; i<wsp3.length;i++){
		wsp0_3+=wsp3.eq(i).width();
	}
	$('#content_div3 ul li').css('width',wsp0_3);
}
h0();


$(function(){
    var M1 = $('.top_ul_z')
    M1.on('click',function(e){e.stopPropagation();})
    .find('#yg_in').on('click',function(){
        M1.find('.top_ul').show();
    });
    $(document).on('click',function(){M1.find('.top_ul').hide()})
})
$('#yg_in').toggle(function(){
	$('.top_ul').show();	
},function(){
	$('.top_ul').hide();	
})
$('.qx,.qd').click(function(){
	$('.top_ul').hide();	
})


$("input[type='radio']").click(function(){
	var v = $(this).val();
	if (v == "0"){
		$("#gslb").show();
		$("#bmlb,#gwlb,#yglb").hide();
	}
	if (v =="1"){
		$("#bmlb").show();
		$("#gslb,#gwlb,#yglb").hide(); 
	}
	if(v=="2"){
		$("#gwlb").show();
		$("#gslb,#bmlb,#yglb").hide();
	}
	if(v=="3"){
		$("#yglb").show();
		$("#gslb,#bmlb,#gwlb").hide();
	}
});

//公司列表弹窗
//编辑
$("#a_gsbj").click(function(){
	$("#tc_gsbj").show();
	$(".bottom_sp3,.bottom_sp4").click(function(){
		$("#tc_gsbj").hide();	
	})	
})
//添加
$("#a_gstj").click(function(){
	$("#tc_gstj").show();
	$(".bottom_sp3,.bottom_sp4").click(function(){
		$("#tc_gstj").hide();	
	})
})

//部门页面
//编辑
$("#a_bmbj").click(function(){
	$("#tc_bmbj").show();
	$(".bottom_sp3,.bottom_sp4").click(function(){
		$("#tc_bmbj").hide();	
	})	
})
//添加
$("#a_bmtj").click(function(){
	$.ajax({
		type:'post',
		url:"{:U('getDept')}",
		async:false,
		data:{type:'origin'},
		success:function(data){
			$("#company").html('');
			var html = '<option>请选择公司</option>';
			$.each(data.data, function(k, v){
				html += '<option value="'+v.id+'">'+v.name+'</option>';
			})
			$("#company").html(html);
		}
	});
	$('#bj1').text('添加')
	$("#tc_bmtj").show();
	$(".bottom_sp3,.bottom_sp4").click(function(){
		$("#tc_bmtj").hide();	
	})
})

//添加
$("#a_gwtj").click(function(){
	$.ajax({
		type:'post',
		url:"{:U('getDept')}",
		async:false,
		data:{type:'origin'},
		success:function(data){
			$("#position_company").html('');
			var html = '<option>请选择公司</option>';
			$.each(data.data, function(k, v){
				html += '<option value="'+v.id+'">'+v.name+'</option>';
			})
			$("#position_company").html(html);
		}
	});
	$.ajax({
		type:'post',
		url:"{:U('get_all_position')}",
		async:false,
		success:function(data){
			$("#position_position").html('');
			var html = '<option>请选择岗位</option>';
			$.each(data.data, function(k, v){
				html += '<option value="'+v.id+'">'+v.position_name+'</option>';
			})
			$("#position_position").html(html);
		}
	});
	
	$("#tc_gwtj").show();
	$(".bottom_sp4").click(function(){
		window.onbeforeunload = null;
		if (check_form("form_data_r_dept_position_add")) {
			sendForm("form_data_r_dept_position_add", "{:U('r_dept_position_add')}");
		}	
	})
	$(".bottom_sp3").click(function(){
		$("#tc_gwtj").hide();	
	})
})

$("#a_ygbj").click(function(){
	$('#bj3').text('编辑')
	$("#tc_ygbj").show();
	$(".bottom_sp3,.bottom_sp4").click(function(){
		$("#tc_ygbj").hide();	
	})	
})
function change_dept(company_id,sheet){
	$.ajax({
		type:'post',
		url:"{:U('change_dept_html')}",
		data:{company_id:company_id},
		success:function(result){
			$("#"+sheet+"_dept").html(result.data.dept);
			if(sheet == 'user'){
				$("#"+sheet+"_position").html('');
			}
			$("#"+sheet+"_position_sequence_id").val('');
			$("#"+sheet+"_position_sequence").val('');
		},
		error:function(){
			alert('数据错误');
		}
	})
}
function change_position(dept_id,sheet){
	$.ajax({
		type:'post',
		url:"{:U('change_position_html')}",
		data:{dept_id:dept_id},
		success:function(result){
			$("#"+sheet+"_position").html(result.data.position);
		},
		error:function(){
			alert('数据错误');
		}
	})
}
function change_position_sequence(position_id){
	$.ajax({
		type:'post',
		url:"{:U('change_sequence_html')}",
		data:{position_id:position_id},
		success:function(result){
			$("#user_position_sequence_id").val(result.data.sequence_id);
			$("#user_position_sequence").val(result.data.sequence_name);
		},
		error:function(){
			alert('数据错误');
		}
	})
}
function edit_user(user_id,user_name,dept_id,position_id,is_del,position_sequence){
	$('#bj3').text('编辑')
	$("#user_user_id").val(user_id);
	$("#user_user_name").val(user_name);
	$("#user_position_sequence").val(position_sequence);
	$("#user_origin_dept_id").val(dept_id);
	$("#user_origin_position_id").val(position_id);
	$.ajax({
		type:'post',
		url:"{:U('get_edit_user_html')}",
		data:{user_id:user_id,dept_id:dept_id,position_id:position_id},
		success:function(result){
			//alert(JSON.stringify(result));
			$("#user_company").html(result.data.company);
			$("#user_dept").html(result.data.dept);
			$("#user_position").html(result.data.position);
			$("#user_major").html(result.data.major);
		},
		error:function(){
			alert('数据错误');
		}
	})
	$("#tc_ygbj").show();
	$(".bottom_sp4").click(function(){
		window.onbeforeunload = null;
		if (check_form("form_data_user_edit")) {
			sendForm("form_data_user_edit", "{:U('user_edit')}");
		}
	})	
	$(".bottom_sp3").click(function(){
		$("#tc_ygbj").hide();
	})	
}

$("#a_ygtj").click(function(){
	$('#bj3').text('添加')
	$("#user_user_id").val('');
	$("#user_user_name").val('');
	$("#user_position_sequence").val('');
	$("#user_origin_dept_id").val('');
	$("#user_origin_position_id").val('');
	$("#user_dept").html('');
	$("#user_position").html('');
	$.ajax({
		type:'post',
		url:"{:U('get_edit_user_html')}",
		data:{},
		success:function(result){
			//alert(JSON.stringify(result));
			$("#user_company").html(result.data.company);
			//$("#user_dept").html(result.data.dept);
			//$("#user_position").html(result.data.position);
			$("#user_major").html(result.data.major);
		},
		error:function(){
			alert('数据错误');
		}
	})
	$("#tc_ygbj").show();
	$("#user_user_name").keyup(function(){
		$.ajax({
			type:'post',
			url:"{:U('search_user')}",
			data:{keywords:$(this).val()},
			success:function(result){
				var html = '';
				if(result.data != null){
					$.each(result.data, function(k, v){
						html += '<li class="user_name_search_li" onclick="put_on(\''+v.id+'\',\''+v.name+'\')">'+v.emp_no+'_'+v.name+'</li>'
					})
				}else{
					html += '<li class="user_name_search_li">没有找到数据</li>';
				}
				$(".user_name_search").html(html);
			},
			error:function(){
				alert('数据错误');
			}
		})
		$(".user_name_search").show();
	});
	var M1 = $('.user_name')
    M1.on('click',function(e){e.stopPropagation();})
    $(document).on('click',function(){M1.find('.user_name_search').hide()})
    
	$("#user_user_name").focus(function(){
		$(".user_name_search").show();
	});
	$(".bottom_sp4").click(function(){
		window.onbeforeunload = null;
		if (check_form("form_data_user_edit")) {
			sendForm("form_data_user_edit", "{:U('user_dept_position_set')}");
		}
	})
	$(".bottom_sp3").click(function(){
		$("#tc_ygbj").hide();	
	})
})
function put_on(id,name){
	$("#user_user_id").val(id);
	$("#user_user_name").val(name);
	$(".user_name_search").hide();
}
$("#a_js").click(function(){
	$("#tc_js").show();
	$(".bottom_sp1,.bottom_sp2").click(function(){
		$("#tc_js").hide();	
	})
})
$("#a_xz").click(function(){
	$("#tc_xz").show();
	$(".bottom_sp1,.bottom_sp2").click(function(){
		$("#tc_xz").hide();	
	})
})
$("#a_yw").click(function(){
	$("#tc_yw").show();
	$(".bottom_sp1,.bottom_sp2").click(function(){
		$("#tc_yw").hide();	
	})
})
$("#a_jd").click(function(){
	$("#tc_jd").show();
	$(".bottom_sp1,.bottom_sp2").click(function(){
		$("#tc_jd").hide();	
	})
})

$("#a_kq").click(function(){
	$("#tc_kq").show();
	$(".bottom_sp1,.bottom_sp2").click(function(){
		$("#tc_kq").hide();	
	})
})
$("#a_fp").click(function(){
	$("#tc_fp").show();
	$(".bottom_sp1,.bottom_sp2").click(function(){
		$("#tc_fp").hide();	
	})
})

//组织架构
$(".zz_bg img").each(function(){
	$(this).toggle(function(){
		$(this).parent('li').children('ul').slideDown()
	},function(){
		$(this).parent('li').children('ul').slideUp()
	})
})

$(".tc_ul_div img").each(function(){
	$(this).toggle(function(){
		$(this).parent('li').children('ul').slideDown()
	},function(){
		$(this).parent('li').children('ul').slideUp()
	})
})

$("#js_sp4,#js_sp5").click(function() {
  if(this.checked){                                     
    $("[name=sp4]:checkbox").prop("checked",true);  
  }else{
    $("[name=sp4]:checkbox").prop("checked",false);  
  }
});

$('#all').click(function(){
	if(this.checked){                                     
		$("[name=box]:checkbox").prop("checked",true);  
	}else{
		$("[name=box]:checkbox").prop("checked",false);  
	}	
});
function show_list(id,show_leader,p){
	$("#dept_id").val(id);
	$("#show_leader").val(show_leader);
	var type = $("input[name='radio']:checked").val();
	//sendForm("form_data", "{:U('index')}");
	$.ajax({
		type:'post',
		data:{dept_id:id,type:type,show_leader:show_leader,p:p},
		url:"{:U('changeContent')}",
		async:false,
		success:function(data){
			var type = $("input[name='radio']:checked").val();
			temp = '';
			if(data.data.list != null){
				if(data.data.type == '0'){
					$.each(data.data.list, function(k, v){
						temp += '<li class="content_li">';
						temp += '<span class="span2_0"><input name="box" type="checkbox"/></span>';
						temp += '<span class="span2">'+v.root_name+'</span>';
						temp += '<span class="span2"></span>';
						temp += '<span class="span2"><a class="content_a">启用</a></span>';
						temp += '<span class="span2"><a class="content_a">禁用</a></span>';
						temp += '<span class="span2"><a class="content_a" id="a_gsbj">编辑</a></span>';
						temp += '</li>';
					});
					$('.company_content').html(temp);
					h0();
				}else if(data.data.type == '1'){
					$.each(data.data.list, function(k, v){
						temp += '<li class="content_li">';
						temp += '<span class="span2_0"><input name="box" type="checkbox"/></span>';
						temp += '<span class="span2">'+v.root_name+'</span>';
						temp += '<span class="span2">'+v.name+'</span>';
						temp += '<span class="span2"></span>';
						temp += '<span class="span2"><a class="content_a">启用</a></span>';
						temp += '<span class="span2"><a class="content_a">禁用</a></span>';
						temp += '<span class="span2"><a class="content_a" id="a_bmbj">编辑</a></span>';
						temp += '</li>';
					});
					$('.dept_content').html(temp);
					h0();
				}else if(data.data.type == '2'){
					$.each(data.data.list, function(k, v){
						temp += '<li class="content_li">';
						temp += '<span class="span2_0"><input name="box" type="checkbox"/></span>';
						temp += '<span class="span2">'+v.dept_name+'</span>';
						temp += '<span class="span2">'+v.position_name+'</span>';
						temp += '<span class="span2"></span>';
						temp += '<span class="span2"></span>';
						temp += '<span class="span2"><a class="content_a" id="a_gwbj">编辑</a></span>';
						temp += '<span class="span2"><a class="content_a" id="a_fp">分配情况</a></span>';
						temp += '</li>';
					});
					$('.position_content').html(temp);
					h0();
				}else if(data.data.type == '3'){
					$.each(data.data.list, function(k, v){
						temp += '<li class="content_li">';
						temp += '<span class="span2_0"><input name="box" type="checkbox"/></span>';
						temp += '<span class="span2">'+v.name+'</span>';
						temp += '<span class="span2">'+v.dept_name+'</span>';
						temp += '<span class="span2">'+v.position_name+'</span>';
						temp += '<span class="span2">'+v.major+'</span>';
						temp += '<span class="span2">'+v.is_del+'</span>';
						temp += '<span class="span2">'+v.position_sequence+'</span>';
						temp += '<span class="span2"><a class="content_a" id="a_ygbj" onclick="edit_user(\''+v.id+'\',\''+v.name+'\',\''+v.dept_id+'\',\''+v.position_id+'\',\''+v.is_del+'\',\''+v.position_sequence+'\')">编辑</a></span>';
						temp += '<span class="span2"><a class="content_a" id="a_js">角色分配</a></span>';
						temp += '<span class="span2"><a class="content_a" id="a_xz">行政关系范围</a></span>';
						temp += '<span class="span2"><a class="content_a" id="a_yw">业务管辖部门</a></span>';
						temp += '<span class="span2"><a class="content_a" id="a_jd">业务管辖基地</a></span>';
						temp += '<span class="span2"><a class="content_a" id="a_kq">考勤管辖部门</a></span>';
						temp += '</li>';
					});
					$('.user_content').html(temp);
					h0();
				}
				
				var changepage = "";
				if(data.data.p == 1){
					changepage = "<li><span class='current'>首页</span></li><li><span>« 上一页</span></li>";
					if(data.data.p < data.data.total){
						changepage += "<li><a class='page' href='javascript:void(0)' rel='"+(data.data.p+1)+"'>下一页 »</a></li>";
					}else{
						changepage += "<li><span>下一页 »</span></li>";
					}
				}else if(data.data.p == data.data.total){
					changepage = "<li><a class='page' href='javascript:void(0)' rel='1'>首页</a></li><li><a class='page' href='javascript:void(0)' rel='"+(data.data.p-1)+"'>« 上一页</a></li><li><span>下一页 »</span></li>";
				}else{
					changepage = "<li><a class='page' href='javascript:void(0)' rel='1'>首页</a></li><li><a class='page' href='javascript:void(0)' rel='"+(data.data.p-1)+"'>« 上一页</a></li><li><a class='page' href='javascript:void(0)' rel='"+(data.data.p+1)+"'>下一页 »</a></li>";
				}
				
				$('#ps').html(data.data.p+"/");
				$('#changepages').html(changepage);
				$('#counts').html(data.data.count+"条记录");
				$('#total_pages').html(data.data.total+"页");
				$('.page').click(function(){
					var a = $(this).attr('rel');
					var id = $("#dept_id").val();
					var show_leader = $("#show_leader").val();
					show_list(id,show_leader,a);
				});
			}else{
				$('#d_content').html('<tr><td colspan="7">{:L("NOT_FIND_THE_RESULTS_YOU_WANT")}</td></tr>');
				$('#footers').addClass('hide');
			}
		},
	})
	//alert(id);
}
function getDeptByCompany(){
	var company_id = $("#company").val();
	$.ajax({
		type:'post',
		data:{dept_id:company_id,type:'option'},
		url:"{:U('getDept')}",
		async:false,
		success:function(data){
			$("#dept").html(data.data);
		//	alert(JSON.stringify(data));
		}
	});
}
</script>
