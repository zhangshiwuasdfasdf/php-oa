<script type="text/javascript">
	function add() {
		window.open("{:U('add')}", "_self");
	};

	$(document).ready(function() {
		set_return_url();
		$(".content_a.a1_2").click(function(){
			var id = $(this).parent().parent().find(".li_sp3 input:eq(1)").val();
			var con = $(this).text().trim();
			$.post("{:U('changestatus')}",{"id":id,"status":con},function(data){
				location.reload();
			},'json');
		});
	});
	//添加验证
	function avliAdd(){
		var name = $("#tc_yjtj input[name='menu_name']").val().trim(); 
		if(name == ""){ui_error("请输入菜单名称！");return false;}
		$.post("{:U('avliName')}",{"id":"0","pid":"0","name":name},function(data){
			if (data.status) {
				add();			
			}else{
				$("#tc_yjtj_vali").text(data.info).show();
			}
		},'json');
	}
	//添加菜单
	function add(){
		var status,menu_no,pid;
		var url = "{:U('add')}";
		var name = $("#tc_yjtj input[name='menu_name']").val().trim();
		var addr = $("#tc_yjtj input[name='menu_addr']").val().trim();
		status = $("#tc_yjtj select[name='menu_status']").val().trim();
		var sort = $("#tc_yjtj input[name='sort']").val().trim();
		if(name == ""){ui_error("请输入菜单名称！");return false;}
		if(addr == ""){ui_error("请输入菜单地址！");return false;}
		if(status == ""){ui_error("请输入菜单状态！");return false;}
		$.post(url,{"name":name,"addr":addr,"status":status,"menu_no":menu_no,"pid":pid,"sort":sort},function(data){
			if (data.status) {
				$("#tc_yjtj").hide();
				ui_alert(data.info,function(){
					location.reload();
				});				
			}
		},'json');
	}
	//验证修改
	function avliSave(obj){
		var url,pid,id;
		if($(obj).text() == "修改"){
			url = "{:U('save')}";
			id = $("#menuId").val();
		}else{
			url = "{:U('add')}";
			id = "0";
		}
		var name = $("#tc_ejtj input[name='menu_name']").val().trim();
		if(name == ""){ui_error("请输入菜单名称！");return false;}
		if($("select[name='pid']").prop("disabled")){
			pid = "0";
		}else{
			pid = $("#tc_ejtj select[name='pid']").find("option:selected").val().trim();
		}
		$.post("{:U('avliName')}",{"id":id,"pid":pid,"name":name},function(data){
			if (data.status) {
				save(url,id);			
			}else{
				$("#tc_ejtj_vali").text(data.info).show();
			}
		},'json');
	}
	
	//修改菜单
	function save(url,id){
		var status,menu_no,pid;
		var name = $("#tc_ejtj input[name='menu_name']").val().trim();
		var addr = $("#tc_ejtj input[name='menu_addr']").val().trim();
		menu_no = $("#tc_ejtj input[name='menu_no']").val().trim();
		var sort = $("#tc_ejtj input[name='sort']").val().trim();
		if($("select[name='pid']").prop("disabled")){
			pid = "0";
		}else{
			pid = $("#tc_ejtj select[name='pid']").find("option:selected").val().trim();
		}
		if(menu_no == ""){ui_error("请输入菜单编码！");return false;}
		if(name == ""){ui_error("请输入菜单名称！");return false;}
		if(addr == ""){ui_error("请输入菜单地址！");return false;}
		$.post(url,{"id":id,"name":name,"addr":addr,"status":status,"menu_no":menu_no,"pid":pid,"sort":sort},function(data){
			if (data.status) {
				ui_alert(data.info,function(){
					location.reload();
				});				
			}
		},'json');
	}
	//删除菜单
	$(".b2").click(function(){
		var ids = "";
		$(".content_div2 input:checkbox[name='box']:checked").each(function(){
			ids += $(this).next().val().trim() + ',';
		});
		if(ids != ""){
			ui_confirm('确定要删除吗?',function(){
				window.open(fix_url("{:U('del')}?id=" + ids), "_self");
			});
		}
	});
	
	function contains(arr, obj) {
	    var i = arr.length;
	    while (i--) {
	        if (arr[i] === obj) {
	            return true;
	        }
	    }
	    return false;
	}
	
	$(".a1_3").click(function(){
		var menu_id=$(this).attr('id');
		$("#menu_id_gljs").val(menu_id);
		$.ajax({
			type:'post',
			url:"{:U('show_role')}",
			data:{id:menu_id},
			success:function(data){
				if(data.status == '1'){
					$("input[name='role_id[]']").each(function(){
						var role_id=$(this).val();
						if(data.data['role_id']){
							if(contains(data.data['role_id'],role_id)){
								$(this).prop("checked",true);
							}
						}
					});	
				}
			}
		})
	});
	$(".a1_5").click(function(){
		var menu_id=$(this).attr('id');
		var menu_name=$(this).attr('menu_name');
		$("#now_menu").text(menu_name);
		$("#now_menu_id").val(menu_id);
	});
	$("#search_role").click(function(){
	    var id=$("#menu_id_gljs").attr('value');
	    var name=$("#role_name").val();
	    $(".tc_ul_div #span span").remove();
	    $.ajax({
	        type:'post',
	        url:"{:U('show_role')}",
	        data:{id:id,name:name},
	        success:function(data){
	            if(data.status == '1'){
	                var span='';
	                var s;
	                for (s in data.data) {
	                    $(".tc_div_jt").remove();
	                    span += '<span><input type="checkbox" id="js1_role_id'+data.data[s].id+'" name="role_id[]" value="'+data.data[s].id+'"/><label for="js1_role_id'+data.data[s].id+'">'+data.data[s].role_name +'</label></span>';
	                    
	                }
	                $(".tc_ul_div #span").append(span);
	                $("input[name='role_id[]']").each(function(){
	                    var role_id=$(this).val();
	                    //alert(contains(data.data['role_id'],role_id));
	                    if(contains(data.data['role_id'],role_id)){
	                        $(this).prop("checked",true);
	                    }
	                }); 
	                var sousuo_id=[];
	                for (s in data.data){
	                	sousuo_id.push(data.data[s].id);
	                }
	                $(".tc_ul input[name='role_id[]']").each(function(){
	                    var role_id=$(this).val();
	                    if(!contains(sousuo_id,role_id)){
	                        $(".tc_ul span").remove();
	                    	$(".tc_ul_div #span").append($(this));
	                    	$(this).css('visibility','hidden');
	                    }
	                }); 
	                $(".tc_ul_div #span #js1_role_idundefined").remove();
	                $(".tc_ul_div #span label[for='js1_role_idundefined']").remove();
	            }
	        }
	    })
	});
	  $(".a1_4").click(function(){
	        var menu_id=$(this).attr('id');
	        $("#menu_id_sjkz").val(menu_id);
	        $.ajax({
	            type:'post',
	            url:"{:U('ajax_get_data')}",
	            data:{id:menu_id},
	            success: function(data){
	            	$(".tc_ul_div").html(data);
	            	/* $("#scope option").each(function(){
	            		var scope=$(this).val();
	            		if($data[] == scope){
	            			$(this).prop("selected",true);
	            		}
	            	}) */
	             }
	            
	        })
	  });
</script>